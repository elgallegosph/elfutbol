<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El F√∫tbol - Gesti√≥n en Tiempo Real</title>
    <style>
        :root { --primary: #1a5276; --success: #27ae60; --danger: #c0392b; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        body.modo-visitante .solo-admin { display: none !important; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        .grupo-caja { border: 2px solid var(--primary); padding: 15px; margin-top: 10px; border-radius: 8px; background: #fff; }
        .status-bar { text-align: center; font-weight: bold; margin-bottom: 20px; padding: 10px; border-radius: 5px; background: #eee; }
    </style>
</head>
<body class="modo-visitante" id="mainBody">

<div class="container">
    <header>
        <h1>üèÜ Gesti√≥n de Torneo Pro (Sincronizado)</h1>
        <div id="txtEstado" class="status-bar">MODO VISITANTE</div>
    </header>

    <section class="solo-admin">
        <div class="grid">
            <div>
                <h3>1. Registrar Equipo</h3>
                <input type="text" id="nombreEquipo" placeholder="Nombre del Equipo">
                <button onclick="registrarEquipo()">A√±adir Equipo</button>
            </div>
            <div>
                <h3>2. Registrar Jugadores</h3>
                <select id="selEq" onchange="renderJugadores()"></select>
                <input type="text" id="nombreJug" placeholder="Nombre del Jugador">
                <input type="tel" id="telJug" placeholder="N√∫mero de Tel√©fono">
                <button onclick="registrarJugador()">A√±adir Jugador</button>
            </div>
        </div>
        <hr>
        <div style="display: flex; gap: 10px;">
            <button onclick="realizarSorteo()" style="background: var(--success); flex: 2;">üé≤ Realizar Sorteo de Grupos</button>
            <button onclick="reiniciarTorneo()" style="background: var(--danger); flex: 1;">üóëÔ∏è Reiniciar</button>
        </div>
    </section>

    <div id="displayGrupos" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;"></div>
    
    <div id="seccionJugadores" style="margin-top: 20px;">
        <h3>üìã Lista de Jugadores por Equipo</h3>
        <div id="listaJugadores"></div>
    </div>

    <div id="authPanel" style="margin-top: 40px; padding: 20px; border: 1px solid #ddd; background: #fafafa; border-radius: 8px;">
        <div id="auth-inputs">
            <h3>üîê Iniciar Sesi√≥n / Registrarse</h3>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <div style="display: flex; gap: 10px;">
                <button onclick="login()">Entrar</button>
                <button onclick="register()" style="background: #7f8c8d;">Crear Cuenta</button>
            </div>
        </div>
        <div id="admin-ui" style="display:none; text-align: center;">
            <p>Conectado como: <b id="userEmail"></b></p>
            <button onclick="logout()" style="background: var(--danger); margin-top: 10px;">Cerrar Sesi√≥n</button>
        </div>
    </div>
</div>

<script>
    // La variable dbT ahora se actualizar√° DESDE la nube
    window.dbT = { equipos: [], grupos: {} };

    // Funci√≥n que recibe los datos de app.js (desde Firebase) y actualiza la pantalla
    window.actualizarDesdeNube = function(datosNube) {
        if (datosNube) {
            window.dbT = datosNube;
            render();
        }
    };

    window.registrarEquipo = function() {
        const n = document.getElementById('nombreEquipo').value;
        if(!n) return alert("Escribe un nombre para el equipo");
        dbT.equipos.push({ nombre: n, jugadores: [] });
        sincronizarConNube();
        document.getElementById('nombreEquipo').value = "";
    };

    window.registrarJugador = function() {
        const eqN = document.getElementById('selEq').value;
        const jugN = document.getElementById('nombreJug').value;
        const tel = document.getElementById('telJug').value;
        if(!eqN || !jugN) return alert("Selecciona un equipo e ingresa el nombre del jugador");
        
        const eq = dbT.equipos.find(e => e.nombre === eqN);
        if(eq) {
            eq.jugadores.push({ nombre: jugN, telefono: tel });
            sincronizarConNube();
            document.getElementById('nombreJug').value = "";
            document.getElementById('telJug').value = "";
        }
    };

    window.realizarSorteo = function() {
        if(dbT.equipos.length < 2) return alert("Se necesitan al menos 2 equipos");
        dbT.grupos = { "Grupo A": [], "Grupo B": [] };
        const eqs = [...dbT.equipos].sort(() => Math.random() - 0.5);
        eqs.forEach((e, i) => {
            const g = i % 2 === 0 ? "Grupo A" : "Grupo B";
            dbT.grupos[g].push(e.nombre);
        });
        sincronizarConNube();
    };

    window.reiniciarTorneo = function() {
        if (confirm("¬øBorrar todos los datos del torneo en la NUBE?")) {
            dbT = { equipos: [], grupos: {} };
            sincronizarConNube();
        }
    };

    function sincronizarConNube() {
        // En lugar de localStorage, llamamos a la funci√≥n de app.js que sube a Firebase
        if (window.publicarTorneo) {
            window.publicarTorneo(dbT); 
        }
        render();
    }

    window.render = function() {
        const sel = document.getElementById('selEq');
        const eqActual = sel.value; // Guardar selecci√≥n actual
        
        sel.innerHTML = dbT.equipos.map(e => `<option value="${e.nombre}">${e.nombre}</option>`).join('');
        if (eqActual) sel.value = eqActual;

        document.getElementById('displayGrupos').innerHTML = Object.keys(dbT.grupos).map(k => `
            <div class="grupo-caja"><h3>${k}</h3>${dbT.grupos[k].map(n => `<p>‚öΩ ${n}</p>`).join('')}</div>
        `).join('');

        renderJugadores();
    };

    window.renderJugadores = function() {
        const eqN = document.getElementById('selEq').value;
        const eq = dbT.equipos.find(e => e.nombre === eqN);
        const div = document.getElementById('listaJugadores');
        if(eq && eq.jugadores && eq.jugadores.length > 0) {
            div.innerHTML = `<ul>` + eq.jugadores.map(j => `<li>${j.nombre} - Tel: ${j.telefono || 'N/A'}</li>`).join('') + `</ul>`;
        } else {
            div.innerHTML = "<p>No hay jugadores registrados en este equipo.</p>";
        }
    };

    window.cambiarModo = function(user) {
        const body = document.getElementById('mainBody');
        const ai = document.getElementById('auth-inputs');
        const au = document.getElementById('admin-ui');
        if(user) {
            body.classList.remove('modo-visitante');
            ai.style.display = "none"; au.style.display = "block";
            document.getElementById('userEmail').innerText = user.email;
            document.getElementById('txtEstado').innerText = "‚ö° MODO ADMINISTRADOR (EN L√çNEA)";
        } else {
            body.classList.add('modo-visitante');
            ai.style.display = "block"; au.style.display = "none";
            document.getElementById('txtEstado').innerText = "üëÅÔ∏è MODO VISITANTE (TIEMPO REAL)";
        }
    };
</script>
<script type="module" src="app.js"></script>
</body>
</html>
