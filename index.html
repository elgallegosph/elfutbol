<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Pro - Gesti√≥n Integral</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1a5276; --secondary: #f4f4f4; --accent: #e74c3c; --success: #27ae60; --dark: #2c3e50; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--secondary); padding-bottom: 50px; }
        header { background: var(--primary); color: white; padding: 1.5rem; text-align: center; }
        .container { max-width: 1000px; margin: 10px auto; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        section { margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        h2 { color: var(--primary); border-left: 5px solid var(--primary); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        input, select, button { padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; font-weight: bold; border: none; cursor: pointer; }
        .btn-descargar { background: var(--dark); margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* Captura e Info */
        #zonaCaptura { padding: 15px; background: white; }
        .header-captura { display: none; border-bottom: 3px solid var(--primary); margin-bottom: 15px; padding-bottom: 10px; }
        
        /* Tablas */
        .table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 0.9rem; }
        th { background: #f8f9fa; }
        
        /* Plantillas */
        .card-plantilla { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .equipo-header { background: #f8f9fa; padding: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .jugadores-lista { display: none; padding: 5px; background: #fff; }
        .card-plantilla.active .jugadores-lista { display: block; }
        .jugador-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; }

        /* Marcador */
        .input-marcador { width: 60px !important; text-align: center; font-weight: bold; border: 2px solid var(--primary) !important; }

        /* Permisos */
        body.admin-activo .edit-link { cursor: pointer; color: var(--primary); text-decoration: underline; }
        body.solo-lectura .admin-only { display: none !important; }
    </style>
</head>
<body class="solo-lectura">

<div id="panelAcceso" style="background: var(--dark); color: white; padding: 10px; text-align: center;">
    <div id="modoEspectador">üëÅÔ∏è Modo Espectador <button onclick="login()" style="width:auto; padding:5px 15px; background:var(--accent); margin-left:10px;">Login Admin</button></div>
    <div id="modoAdmin" style="display:none;">üîì Administrador <button onclick="logout()" style="width:auto; padding:5px 15px; background:#7f8c8d; margin-left:10px;">Cerrar</button></div>
</div>

<header>
    <input type="text" id="nombreTorneoInput" placeholder="Nombre del Torneo" style="background:transparent; color:white; border:1px dashed white; text-align:center; font-size:1.5rem; width:80%;">
</header>

<div class="container">
    <section class="admin-only">
        <h2>1. Registro de Equipos</h2>
        <div class="grid">
            <input type="text" id="nomEq" placeholder="Nombre del Equipo">
            <button onclick="addEquipo()">Registrar Equipo</button>
        </div>
    </section>

    <section class="admin-only">
        <h2>2. Configurar Calendario</h2>
        <div class="grid">
            <select id="cantGrupos">
                <option value="1">Liga √önica</option>
                <option value="2">2 Grupos (A y B)</option>
                <option value="4">4 Grupos (A, B, C, D)</option>
            </select>
            <select id="tipoIdaVuelta">
                <option value="1">Solo Ida</option>
                <option value="2">Ida y Vuelta</option>
            </select>
            <button onclick="generarCalendario()" style="background: var(--success);">üé≤ Generar Grupos y Partidos</button>
        </div>
    </section>

    <section class="admin-only">
        <h2>3. Cargar Resultado</h2>
        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
            <div style="display:flex; gap:10px; width:100%;">
                <select id="selLoc" style="flex:2;"></select>
                <input type="number" id="resL" class="input-marcador" value="0">
            </div>
            <div style="display:flex; gap:10px; width:100%;">
                <input type="number" id="resV" class="input-marcador" value="0">
                <select id="selVis" style="flex:2;"></select>
            </div>
            <button onclick="guardarResultado()" style="width:100%;">Registrar Partido</button>
        </div>
    </section>

    <section class="admin-only">
        <h2>4. Goles y Tarjetas</h2>
        <div class="grid">
            <select id="selEqEv" onchange="updateSelJug()"></select>
            <select id="selJugEv"></select>
            <select id="tipoEv">
                <option value="gol">‚öΩ Gol</option>
                <option value="ama">üü® Amarilla</option>
                <option value="roja">üü• Roja</option>
            </select>
            <button onclick="addEvento()">Grabar Evento</button>
        </div>
    </section>

    <section>
        <h2>5. Posiciones y Estad√≠sticas</h2>
        <button class="btn-descargar" onclick="descargarImagen()">üì∏ Descargar Tabla (Imagen)</button>
        
        <div id="zonaCaptura">
            <div class="header-captura" id="capHeader">
                <h1 id="capTitulo"></h1>
                <p id="capFecha"></p>
            </div>
            <div id="tablasPosiciones"></div>
        </div>
    </section>

    <section>
        <h2>6. Calendario de Partidos</h2>
        <input type="text" id="busq" placeholder="üîç Buscar equipo..." onkeyup="render()">
        <div id="listaPartidos" style="margin-top:15px; max-height:400px; overflow-y:auto;"></div>
    </section>

    <section>
        <h2>7. Plantillas y Goleadores</h2>
        <div class="admin-only" style="margin-bottom:15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
            <select id="selEqPlantilla"></select>
            <input type="text" id="nomJugPlantilla" placeholder="Nombre Jugador">
            <button onclick="addJugador()">A√±adir a Plantilla</button>
        </div>
        <div id="plantillasContenedor"></div>
    </section>

    <button class="admin-only" onclick="resetTorneo()" style="background:var(--accent); margin-top:50px;">üóëÔ∏è REINICIAR TODO EL TORNEO</button>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('torneo_pro_v4')) || { 
        nombre: "MI TORNEO", 
        equipos: [], 
        partidos: [] 
    };

    function login() { if(prompt("PIN:")==="1234") { localStorage.setItem('isAdmin', 'true'); location.reload(); } }
    function logout() { localStorage.removeItem('isAdmin'); location.reload(); }

    function addEquipo() {
        const n = document.getElementById('nomEq').value.trim();
        if(n) { db.equipos.push({ nombre: n, grupo: 'A', pj:0, pg:0, pe:0, pp:0, gf:0, gc:0, pts:0, jugadores:[] }); save(); }
    }

    function generarCalendario() {
        if(db.equipos.length < 2) return alert("M√≠nimo 2 equipos");
        const nG = parseInt(document.getElementById('cantGrupos').value);
        const tipo = parseInt(document.getElementById('tipoIdaVuelta').value);
        
        // Asignar Grupos
        db.equipos.sort(() => Math.random() - 0.5);
        db.equipos.forEach((e, i) => {
            e.grupo = String.fromCharCode(65 + (i % nG));
            e.pj=0; e.pg=0; e.pe=0; e.pp=0; e.gf=0; e.gc=0; e.pts=0;
        });

        // Crear Partidos (Sin mezclar grupos)
        db.partidos = [];
        const grupos = [...new Set(db.equipos.map(e => e.grupo))];
        grupos.forEach(g => {
            const eqs = db.equipos.filter(e => e.grupo === g);
            for(let i=0; i<eqs.length; i++) {
                for(let j=i+1; j<eqs.length; j++) {
                    db.partidos.push({ id: Math.random(), g, loc: eqs[i].nombre, vis: eqs[j].nombre, jug: false, gl:0, gv:0 });
                    if(tipo === 2) db.partidos.push({ id: Math.random(), g, loc: eqs[j].nombre, vis: eqs[i].nombre, jug: false, gl:0, gv:0 });
                }
            }
        });
        save();
    }

    function guardarResultado() {
        const l = document.getElementById('selLoc').value, v = document.getElementById('selVis').value;
        const gl = parseInt(document.getElementById('resL').value), gv = parseInt(document.getElementById('resV').value);
        const p = db.partidos.find(x => !x.jug && x.loc === l && x.vis === v);
        if(!p) return alert("Partido no encontrado o ya jugado");

        let el = db.equipos.find(e => e.nombre === l), ev = db.equipos.find(e => e.nombre === v);
        p.gl = gl; p.gv = gv; p.jug = true;
        el.pj++; ev.pj++; el.gf += gl; el.gc += gv; ev.gf += gv; ev.gc += gl;

        if(gl > gv) { el.pg++; el.pts += 3; ev.pp++; }
        else if(gv > gl) { ev.pg++; ev.pts += 3; el.pp++; }
        else { el.pe++; ev.pe++; el.pts += 1; ev.pts += 1; }
        save();
    }

    function addJugador() {
        const eq = db.equipos.find(e => e.nombre === document.getElementById('selEqPlantilla').value);
        const n = document.getElementById('nomJugPlantilla').value.trim();
        if(eq && n) { eq.jugadores.push({ nombre: n, g:0, a:0, r:0 }); save(); }
    }

    function addEvento() {
        const eq = db.equipos.find(e => e.nombre === document.getElementById('selEqEv').value);
        const jug = eq?.jugadores.find(j => j.nombre === document.getElementById('selJugEv').value);
        if(!jug) return;
        const t = document.getElementById('tipoEv').value;
        if(t === 'gol') jug.g++; else if(t === 'ama') jug.a++; else jug.r++;
        save();
    }

    function editNombre(tipo, original, eqNom = '') {
        if(localStorage.getItem('isAdmin') !== 'true') return;
        const nuevo = prompt("Nuevo nombre:", original);
        if(!nuevo) return;
        if(tipo === 'eq') {
            db.partidos.forEach(p => { if(p.loc === original) p.loc = nuevo; if(p.vis === original) p.vis = nuevo; });
            db.equipos.find(e => e.nombre === original).nombre = nuevo;
        } else {
            db.equipos.find(e => e.nombre === eqNom).jugadores.find(j => j.nombre === original).nombre = nuevo;
        }
        save();
    }

    function save() {
        db.nombre = document.getElementById('nombreTorneoInput').value;
        localStorage.setItem('torneo_pro_v4', JSON.stringify(db));
        render();
    }

    function updateSelJug() {
        const s = document.getElementById('selJugEv'); s.innerHTML = '';
        const eq = db.equipos.find(e => e.nombre === document.getElementById('selEqEv').value);
        eq?.jugadores.forEach(j => s.innerHTML += `<option>${j.nombre}</option>`);
    }

    function render() {
        const admin = localStorage.getItem('isAdmin') === 'true';
        document.body.className = admin ? 'admin-activo' : 'solo-lectura';
        document.getElementById('modoAdmin').style.display = admin ? 'block' : 'none';
        document.getElementById('modoEspectador').style.display = admin ? 'none' : 'block';
        document.getElementById('nombreTorneoInput').value = db.nombre;
        document.getElementById('nombreTorneoInput').disabled = !admin;

        // Selects
        ['selEqPlantilla','selLoc','selVis','selEqEv'].forEach(id => {
            const s = document.getElementById(id); const val = s.value;
            s.innerHTML = ''; db.equipos.forEach(e => s.innerHTML += `<option>${e.nombre}</option>`);
            s.value = val;
        });

        // Tablas por Grupo
        const contT = document.getElementById('tablasPosiciones'); contT.innerHTML = '';
        const grupos = [...new Set(db.equipos.map(e => e.grupo))].sort();
        grupos.forEach(g => {
            let h = `<h3>Grupo ${g}</h3><div class="table-container"><table><thead><tr><th>Equipo</th><th>PJ</th><th>PG</th><th>PE</th><th>PP</th><th>DG</th><th>Pts</th></tr></thead><tbody>`;
            db.equipos.filter(e => e.grupo === g).sort((a,b) => b.pts - a.pts || (b.gf-b.gc)-(a.gf-a.gc)).forEach(e => {
                h += `<tr><td class="edit-link" onclick="editNombre('eq','${e.nombre}')">${e.nombre}</td><td>${e.pj}</td><td>${e.pg}</td><td>${e.pe}</td><td>${e.pp}</td><td>${e.gf-e.gc}</td><td><b>${e.pts}</b></td></tr>`;
            });
            contT.innerHTML += h + '</tbody></table></div>';
        });

        // Calendario
        const bus = document.getElementById('busq').value.toLowerCase();
        const contC = document.getElementById('listaPartidos'); contC.innerHTML = '';
        db.partidos.forEach(p => {
            if(p.loc.toLowerCase().includes(bus) || p.vis.toLowerCase().includes(bus)) {
                contC.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; background:${p.jug?'#f9f9f9':'#fff'}">
                    <span><small>${p.g}</small> | ${p.loc} <b>${p.jug?p.gl+' - '+p.gv:'vs'}</b> ${p.vis}</span>
                    ${!p.jug && admin ? `<button style="width:auto; padding:2px 8px;" onclick="document.getElementById('selLoc').value='${p.loc}';document.getElementById('selVis').value='${p.vis}';window.scrollTo(0,0)">üìù</button>`:''}
                </div>`;
            }
        });

        // Plantillas
        const contP = document.getElementById('plantillasContenedor'); contP.innerHTML = '';
        db.equipos.forEach(e => {
            const jgs = e.jugadores.map(j => `<div class="jugador-item"><span class="edit-link" onclick="editNombre('jug','${j.nombre}','${e.nombre}')">üë§ ${j.nombre}</span> <span>‚öΩ${j.g} üü®${j.a} üü•${j.r}</span></div>`).join('');
            contP.innerHTML += `<div class="card-plantilla"><div class="equipo-header" onclick="this.parentElement.classList.toggle('active')"><span>${e.nombre} (G: ${e.grupo})</span><span>${e.jugadores.length} Ver ‚ñº</span></div><div class="jugadores-lista">${jgs || 'Sin jugadores'}</div></div>`;
        });
    }

    function descargarImagen() {
        const h = document.getElementById('capHeader');
        document.getElementById('capTitulo').innerText = db.nombre;
        document.getElementById('capFecha').innerText = "Corte: " + new Date().toLocaleString();
        h.style.display = 'block';
        html2canvas(document.getElementById('zonaCaptura')).then(canvas => {
            const link = document.createElement('a');
            link.download = `Posiciones_${db.nombre}.png`;
            link.href = canvas.toDataURL();
            link.click();
            h.style.display = 'none';
        });
    }

    function resetTorneo() { if(confirm("¬øBORRAR TODO?")) { localStorage.clear(); location.reload(); } }

    render();
</script>
</body>
</html>
