<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Pro - Sincronizaci√≥n Total</title>
    <style>
        :root { --primary: #1a5276; --success: #27ae60; --danger: #c0392b; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        /* Control de Visibilidad Admin/Visitante */
        body.modo-visitante .solo-admin { display: none !important; }
        
        header { text-align: center; border-bottom: 3px solid var(--primary); margin-bottom: 30px; padding-bottom: 10px; }
        .status-bar { padding: 10px; text-align: center; font-weight: bold; border-radius: 5px; background: #eee; margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .grupo-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .grupo-caja { border: 2px solid var(--primary); padding: 15px; border-radius: 8px; background: #fdfdfd; }
        .grupo-caja h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #eee; }
        
        .lista-jugadores { margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .jugador-item { background: white; padding: 8px 12px; margin: 5px 0; border-radius: 4px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; }
        
        #authPanel { margin-top: 40px; padding: 25px; border-radius: 10px; background: #f1f1f1; border: 1px solid #ddd; }
    </style>
</head>
<body class="modo-visitante" id="mainBody">

<div class="container">
    <header>
        <h1>üèÜ Gesti√≥n de Torneo de F√∫tbol</h1>
        <div id="txtEstado" class="status-bar">üîÑ CONECTANDO CON LA NUBE...</div>
    </header>

    <section class="solo-admin">
        <div class="grid">
            <div class="card">
                <h3>‚öΩ Registrar Equipo</h3>
                <input type="text" id="nombreEquipo" placeholder="Ej: Real Madrid">
                <button onclick="registrarEquipo()">A√±adir Equipo</button>
            </div>
            <div class="card">
                <h3>üë• Registrar Jugadores</h3>
                <select id="selEq" onchange="renderJugadores()"></select>
                <input type="text" id="nombreJug" placeholder="Nombre completo">
                <input type="tel" id="telJug" placeholder="Tel√©fono de contacto">
                <button onclick="registrarJugador()">A√±adir Jugador al Equipo</button>
            </div>
        </div>
        
        <div class="card" style="text-align: center; border-color: var(--success);">
            <h3>üé≤ Sorteo y Reinicio</h3>
            <div style="display: flex; gap: 10px;">
                <button onclick="realizarSorteo()" style="background: var(--success); flex: 2;">REALIZAR SORTEO DE GRUPOS</button>
                <button onclick="reiniciarTorneo()" style="background: var(--danger); flex: 1;">BORRAR TODO</button>
            </div>
        </div>
    </section>

    <div id="seccionGrupos">
        <h2>üìä Grupos del Torneo</h2>
        <div id="displayGrupos" class="grupo-container">
            </div>
    </div>

    <div class="lista-jugadores">
        <h3>üìã Jugadores por Equipo</h3>
        <p style="font-size: 0.9em; color: #666;">Selecciona un equipo arriba para ver su plantilla.</p>
        <div id="listaJugadores">
            </div>
    </div>

    <div id="authPanel">
        <div id="auth-inputs">
            <h3>üîê Acceso Administrativo</h3>
            <p>Inicia sesi√≥n para registrar datos o realizar sorteos.</p>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <div style="display: flex; gap: 10px;">
                <button onclick="login()">Entrar</button>
                <button onclick="register()" style="background: #7f8c8d;">Crear Cuenta Admin</button>
            </div>
        </div>
        
        <div id="admin-ui" style="display:none; text-align: center;">
            <p>‚úÖ Sesi√≥n iniciada como: <b id="userEmail"></b></p>
            <button onclick="logout()" style="background: var(--danger); max-width: 200px;">Cerrar Sesi√≥n</button>
        </div>
    </div>
</div>

<script>
    // Variable global sincronizada
    window.dbT = { equipos: [], grupos: {} };

    // RECIBIR DATOS: Funci√≥n que llama app.js cuando Firebase detecta cambios
    window.actualizarDesdeNube = function(datosNube) {
        if (datosNube) {
            window.dbT = datosNube;
            render();
            console.log("Datos actualizados desde la nube.");
            if(document.body.classList.contains('modo-visitante')) {
                document.getElementById('txtEstado').innerText = "üëÅÔ∏è MODO VISITANTE (TIEMPO REAL)";
            }
        }
    };

    // ACCI√ìN: Registrar Equipo
    window.registrarEquipo = function() {
        const n = document.getElementById('nombreEquipo').value.trim();
        if(!n) return alert("Ingresa el nombre del equipo");
        dbT.equipos.push({ nombre: n, jugadores: [] });
        subirANube();
        document.getElementById('nombreEquipo').value = "";
    };

    // ACCI√ìN: Registrar Jugador
    window.registrarJugador = function() {
        const eqN = document.getElementById('selEq').value;
        const jugN = document.getElementById('nombreJug').value.trim();
        const tel = document.getElementById('telJug').value.trim();
        
        if(!eqN || !jugN) return alert("Selecciona equipo e ingresa nombre del jugador");
        
        const eq = dbT.equipos.find(e => e.nombre === eqN);
        if(eq) {
            eq.jugadores.push({ nombre: jugN, telefono: tel });
            subirANube();
            document.getElementById('nombreJug').value = "";
            document.getElementById('telJug').value = "";
        }
    };

    // ACCI√ìN: Sorteo
    window.realizarSorteo = function() {
        if(dbT.equipos.length < 2) return alert("M√≠nimo 2 equipos para sortear");
        dbT.grupos = { "Grupo A": [], "Grupo B": [] };
        const eqs = [...dbT.equipos].sort(() => Math.random() - 0.5);
        eqs.forEach((e, i) => {
            const g = i % 2 === 0 ? "Grupo A" : "Grupo B";
            dbT.grupos[g].push(e.nombre);
        });
        subirANube();
    };

    // ACCI√ìN: Reiniciar
    window.reiniciarTorneo = function() {
        if (confirm("‚ö†Ô∏è ¬°PELIGRO! Esto borrar√° permanentemente todos los equipos y jugadores en TODOS los dispositivos. ¬øContinuar?")) {
            dbT = { equipos: [], grupos: {} };
            subirANube();
        }
    };

    // SINCRONIZAR: Env√≠a datos a app.js para Firebase
    function subirANube() {
        if (window.publicarTorneo) {
            window.publicarTorneo(dbT); 
        }
        render(); // Actualizaci√≥n visual inmediata local
    }

    // VISUALIZAR: Dibuja todo en pantalla
    window.render = function() {
        const sel = document.getElementById('selEq');
        const eqAnterior = sel.value;
        
        // Actualizar select de equipos
        sel.innerHTML = dbT.equipos.map(e => `<option value="${e.nombre}">${e.nombre}</option>`).join('');
        if(eqAnterior) sel.value = eqAnterior;

        // Dibujar Grupos
        document.getElementById('displayGrupos').innerHTML = Object.keys(dbT.grupos).length > 0 ? 
            Object.keys(dbT.grupos).map(k => `
                <div class="grupo-caja">
                    <h3>${k}</h3>
                    ${dbT.grupos[k].map(n => `<p>‚öΩ ${n}</p>`).join('')}
                </div>
            `).join('') : "<p>Esperando sorteo de grupos...</p>";

        renderJugadores();
    };

    window.renderJugadores = function() {
        const eqN = document.getElementById('selEq').value;
        const eq = dbT.equipos.find(e => e.nombre === eqN);
        const div = document.getElementById('listaJugadores');
        
        if(eq && eq.jugadores && eq.jugadores.length > 0) {
            div.innerHTML = eq.jugadores.map(j => `
                <div class="jugador-item">
                    <span>üë§ ${j.nombre}</span>
                    <span style="color: #666; font-size: 0.85em;">üìû ${j.telefono || 'Sin tel'}</span>
                </div>
            `).join('');
        } else {
            div.innerHTML = "<p>No hay jugadores en este equipo.</p>";
        }
    };

    // MODO ADMIN: Controlado por app.js (onAuthStateChanged)
    window.cambiarModo = function(user) {
        const body = document.getElementById('mainBody');
        const ai = document.getElementById('auth-inputs');
        const au = document.getElementById('admin-ui');
        const txt = document.getElementById('txtEstado');

        if(user) {
            body.classList.remove('modo-visitante');
            ai.style.display = "none";
            au.style.display = "block";
            document.getElementById('userEmail').innerText = user.email;
            txt.innerText = "‚ö° MODO ADMINISTRADOR (CONECTADO)";
            txt.style.color = "#27ae60";
        } else {
            body.classList.add('modo-visitante');
            ai.style.display = "block";
            au.style.display = "none";
            txt.innerText = "üëÅÔ∏è MODO VISITANTE (TIEMPO REAL)";
            txt.style.color = "#1a5276";
        }
    };
</script>

<script type="module" src="app.js"></script>
</body>
</html>
